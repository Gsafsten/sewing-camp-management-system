<!--Garrett Safsten, Will Knudson, Willard Richards, and Logan Johnson
This view allows admin staff to manually add a new participant to the system without requiring public registration.-->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin - Add Record</title>
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&display=swap" rel="stylesheet">
<style>
/* PAGE LAYOUT AND STYLING */
body{background:linear-gradient(180deg,#fffefa 0%, #f6f9ff 100%); font-family:'Nunito', Arial, sans-serif; margin:0; padding:22px; color:#222}
table[width="700"]{margin:0 auto}
img[alt="Sewing Made Simple for Kids Banner"]{display:block;margin:10px auto;max-width:552px;width:100%;height:auto}

/* NAVIGATION BAR */
.navbar{background:linear-gradient(135deg,#2a3d66 0%, #0b3d8a 100%); padding:0; margin:0 auto 20px; border-radius:10px; max-width:920px; display:flex; align-items:center; justify-content:center; flex-wrap:wrap}
.navbar-menu{display:flex; list-style:none; margin:0; padding:0}
.navbar-item a{display:block; padding:14px 14px; color:#fff; text-decoration:none; font-weight:700}
.navbar-actions{display:flex; gap:8px; padding:8px 16px; margin-left:auto}

/* MAIN CONTAINER */
.container{max-width:900px; margin:18px auto; background:#fff; padding:30px; border-radius:10px; box-shadow:0 10px 30px rgba(11,63,136,0.06)}
h2{color:#d6336c; font-family:'Fredoka', sans-serif; margin-top: 0;}

/* FORM STYLING */
.form-group { margin-bottom: 15px; }
label{display:block; margin-bottom:6px; font-weight:700; color:#2a3d66}
input, select, textarea {
    width: 100%; 
    padding: 10px; 
    border: 1px solid #e6e9ef; 
    border-radius: 8px; 
    box-sizing: border-box; 
    font-family: inherit;
}

/* CHECKBOX STYLING */
input[type="checkbox"] {
    width: auto;
    display: inline-block;
    margin-right: 8px;
    vertical-align: middle;
}

/* TWO-COLUMN LAYOUT FOR FORM */
.row { 
    display: flex; 
    gap: 15px; 
    margin-bottom: 0; 
}
.col { 
    flex: 1; 
    min-width: 0; 
}

/* BUTTONS */
.btn-submit{background:linear-gradient(135deg,#10b981,#0ea77a); color:#fff; padding:12px 18px; border-radius:8px; border:none; font-weight:700; cursor: pointer; display: block; width: 100%; margin-top: 20px;}
.btn-back{display:inline-block; color:#555; margin-bottom:12px; text-decoration: none; font-weight: bold;}

/* MODAL FOR WAIVER/TERMS -->
.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.45); display: none; align-items: center; justify-content: center; z-index: 1000; }
.modal { background: #fff; max-width: 640px; width: 92%; padding: 18px; border-radius: 10px; box-shadow: 0 10px 40px rgba(11, 63, 136, 0.24); } 
.modal-header { font-weight: 700; margin-bottom: 8px; color:#0b63ff; font-size: 1.2em; }
.modal-close { float: right; cursor: pointer; font-size: 20px; padding: 6px; background: none; border: none; color: #666; }
.modal-body p, .modal-body li { color:#333; line-height:1.45; }
.modal-body ul { padding-left: 20px; }

/* RESPONSIVE - stack form columns on mobile */
@media(max-width:700px){
    .row{flex-direction:column; gap: 0;}
}
</style>
</head>
<body>

<div class="container">
    <!-- BACK BUTTON -->
    <a href="/admin" class="btn-back">‚Üê Back to Dashboard</a>
    
    <h2>Add New Registration</h2>

    <!-- ADMIN ADD FORM - collects all participant and parent information -->
    <form action="/admin/add" method="POST">
        
        <!-- SEASON AND SESSION SELECTION -->
        <div class="row">
            <div class="col form-group">
                <label>Season*</label>
                <select id="seasonSelect" name="season" required>
                    <option value="">Select Season</option>
                    <option value="Valentine">Valentine</option>
                    <option value="Easter">Easter</option>
                    <option value="Summer">Summer</option>
                    <option value="Halloween">Halloween</option>
                    <option value="Christmas">Christmas</option>
                </select>
            </div>
            <div class="col form-group">
                <label>Session*</label>
                <select id="sessionSelect" name="selected_session" required disabled>
                    <option value="">Select a Season first</option>
                </select>
            </div>
        </div>

        <!-- CHILD/PARTICIPANT INFORMATION -->
        <div class="row">
            <div class="col form-group">
                <label>Child First Name*</label>
                <input type="text" name="first_name" required>
            </div>
            <div class="col form-group">
                <label>Child Last Name*</label>
                <input type="text" name="last_name" required>
            </div>
        </div>

        <!-- BIRTHDATE AND AGE -->
        <div class="row">
            <div class="col form-group">
                <label>Birthdate*</label>
                <input type="date" name="birthdate" required>
            </div>
            <div class="col form-group">
                <label>Age</label>
                <input type="number" name="age" readonly style="background:#f4f4f4; color: #666;" required>
            </div>
        </div>

        <!-- PARENT/GUARDIAN INFORMATION -->
        <div class="row">
            <div class="col form-group">
                <label>Parent First Name*</label>
                <input type="text" name="parent_first_name" required>
            </div>
            <div class="col form-group">
                <label>Parent Last Name*</label>
                <input type="text" name="parent_last_name" required>
            </div>
        </div>

        <div class="form-group">
            <label>Parent Email*</label>
            <input type="email" name="email" required>
        </div>

        <div class="form-group">
            <label>Parent Phone*</label>
            <input type="tel" name="phone" required>
        </div>

        <!-- ADDRESS INFORMATION -->
        <div class="form-group">
            <label>Street Address*</label>
            <input type="text" name="street_address" required>
        </div>

        <div class="row">
            <div class="col form-group">
                <label>City*</label>
                <input type="text" name="city" required>
            </div>
            <div class="col form-group">
                <label>State*</label>
                <select name="state" required>
                    <option value="MD" selected>Maryland</option>
                    <option value="VA">Virginia</option>
                    <option value="PA">Pennsylvania</option>
                    <option value="AL">Alabama</option>
                    <option value="AK">Alaska</option>
                    <option value="AZ">Arizona</option>
                    <option value="AR">Arkansas</option>
                    <option value="CA">California</option>
                    <option value="CO">Colorado</option>
                    <option value="CT">Connecticut</option>
                    <option value="DE">Delaware</option>
                    <option value="FL">Florida</option>
                    <option value="GA">Georgia</option>
                    <option value="HI">Hawaii</option>
                    <option value="ID">Idaho</option>
                    <option value="IL">Illinois</option>
                    <option value="IN">Indiana</option>
                    <option value="IA">Iowa</option>
                    <option value="KS">Kansas</option>
                    <option value="KY">Kentucky</option>
                    <option value="LA">Louisiana</option>
                    <option value="ME">Maine</option>
                    <option value="MA">Massachusetts</option>
                    <option value="MI">Michigan</option>
                    <option value="MN">Minnesota</option>
                    <option value="MS">Mississippi</option>
                    <option value="MO">Missouri</option>
                    <option value="MT">Montana</option>
                    <option value="NE">Nebraska</option>
                    <option value="NV">Nevada</option>
                    <option value="NH">New Hampshire</option>
                    <option value="NJ">New Jersey</option>
                    <option value="NM">New Mexico</option>
                    <option value="NY">New York</option>
                    <option value="NC">North Carolina</option>
                    <option value="ND">North Dakota</option>
                    <option value="OH">Ohio</option>
                    <option value="OK">Oklahoma</option>
                    <option value="OR">Oregon</option>
                    <option value="RI">Rhode Island</option>
                    <option value="SC">South Carolina</option>
                    <option value="SD">South Dakota</option>
                    <option value="TN">Tennessee</option>
                    <option value="TX">Texas</option>
                    <option value="UT">Utah</option>
                    <option value="VT">Vermont</option>
                    <option value="WA">Washington</option>
                    <option value="WV">West Virginia</option>
                    <option value="WI">Wisconsin</option>
                    <option value="WY">Wyoming</option>
                </select>
            </div>
            <div class="col form-group">
                <label>Zip*</label>
                <input type="text" name="zipcode" required>
            </div>
        </div>

        <div class="form-group">
            <label>Notes</label> <textarea name="special_requests"></textarea> </div>

        <div class="form-group">
            <input type="checkbox" id="agree" name="agree" required>
            <label for="agree" style="display:inline; font-weight:normal;">Waiver Agreed (Manual Entry)</label>
        </div>

        <button type="submit" class="btn-submit">Add Record</button>
    </form>
</div>

<div id="termsModalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
        <div class="modal-header">Terms and Conditions <button type="button" class="modal-close">&times;</button></div>
        <div class="modal-body" style="max-height:60vh; overflow:auto;">
            <h4>Waiver and Liability Release</h4>
            <p><strong>Terms*</strong></p>
            <p>I HAVE READ AND FULLY UNDERSTAND BOTH THE WAIVER AND LIABILITY RELEASE OF CLAIM FORMS.</p>
        </div>
        <div style="text-align:right; margin-top:8px;">
            <button type="button" class="modal-close" style="padding: 8px 16px; background: #ddd; border-radius: 4px; border:none; cursor:pointer;">Close</button>
        </div>
    </div>
</div>

<script>
(function () {
    // 0. Session Data from Server
    const sessions = <%- JSON.stringify(sessions || []) %>;

    // 1. Age Calculation Logic
    function calculateAgeFromDOB(dobString) {
        if (!dobString) return '';
        const today = new Date();
        const dob = new Date(dobString);
        if (isNaN(dob)) return '';
        let age = today.getFullYear() - dob.getFullYear();
        const m = today.getMonth() - dob.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < dob.getDate())) {
            age--;
        }
        return age >= 0 ? age : '';
    }

    // 2. Phone Formatting Logic
    function formatPhoneDigits(digits) {
        if (digits.length < 4) return digits;
        if (digits.length < 7) return digits.slice(0,3) + '-' + digits.slice(3);
        return digits.slice(0,3) + '-' + digits.slice(3,6) + '-' + digits.slice(6,10);
    }

    // 3. Helper for Date/Time Formatting
    function formatDateStr(d) {
        const date = new Date(d);
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const mon = months[date.getMonth()];
        const dd = String(date.getDate()).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${mon}-${dd}-${yyyy}`;
    }

    function formatTimeStr(t) {
        if (!t) return '';
        let [hours, minutes] = t.split(':');
        hours = parseInt(hours);
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12;
        hours = hours ? hours : 12; 
        return `${hours}:${minutes}${ampm}`;
    }

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form[action="/admin/add"]') || document.querySelector('form');
        const birthInput = form.querySelector('input[name="birthdate"]');
        const ageInput = form.querySelector('input[name="age"]');
        const phoneInput = form.querySelector('input[name="phone"]');

        // --- NEW: Dropdown Logic ---
        const seasonSelect = document.getElementById('seasonSelect');
        const sessionSelect = document.getElementById('sessionSelect');

        if (seasonSelect && sessionSelect) {
            seasonSelect.addEventListener('change', function() {
                const season = this.value;
                
                // Clear existing options
                sessionSelect.innerHTML = '';

                if (season) {
                    // Enable and Populate
                    sessionSelect.disabled = false;
                    
                    // Add default prompt
                    const defaultOpt = document.createElement('option');
                    defaultOpt.value = "";
                    defaultOpt.textContent = "Select a Session";
                    sessionSelect.appendChild(defaultOpt);

                    // Add sessions from DB
                    const filteredSessions = sessions.filter(s => (s.season || 'Summer') === season);

                    if (filteredSessions.length > 0) {
                        filteredSessions.forEach(s => {
                            const opt = document.createElement('option');
                            opt.value = s.Sessionid; 
                            
                            // Check for capacity
                            const enrolled = parseInt(s.enrolled_count || 0);
                            const max = parseInt(s.numseats || 0);
                            const isFull = enrolled >= max;

                            const dateRange = `${formatDateStr(s.startdate)} to ${formatDateStr(s.enddate)}`;
                            const timeRange = `${formatTimeStr(s.starttime)} - ${formatTimeStr(s.endtime)}`;
                            
                            let text = `${s.Sessionname}: ${dateRange} (${timeRange})`;
                            
                            if (isFull) {
                                text += " - FULL";
                                opt.disabled = true;
                                opt.style.color = "#aaa";
                            } else {
                                text += ` (${enrolled}/${max})`;
                            }

                            opt.textContent = text;
                            sessionSelect.appendChild(opt);
                        });
                    } else {
                        const opt = document.createElement('option');
                        opt.textContent = "No sessions available for this season";
                        sessionSelect.appendChild(opt);
                    }
                } else {
                    // Reset if no season selected
                    sessionSelect.disabled = true;
                    const opt = document.createElement('option');
                    opt.textContent = "Select a Season first";
                    sessionSelect.appendChild(opt);
                }
            });
        }

        // Set Max Date to Today
        const todayStr = new Date().toISOString().split('T')[0];
        if(birthInput) birthInput.setAttribute('max', todayStr);

        // Update Age on Change
        function updateAge() {
            const age = calculateAgeFromDOB(birthInput.value);
            ageInput.value = age === '' ? '' : age;
        }
        if(birthInput) {
            birthInput.addEventListener('input', updateAge);
            birthInput.addEventListener('change', updateAge);
        }

        // Phone Formatting Events
        if(phoneInput) {
            phoneInput.addEventListener('input', function (e) {
                const digits = (e.target.value || '').replace(/\D/g, '').slice(0,10);
                e.target.value = formatPhoneDigits(digits);
            });
            phoneInput.addEventListener('blur', function (e) {
                const digits = (e.target.value || '').replace(/\D/g, '');
                if (digits.length === 10) {
                    e.target.value = formatPhoneDigits(digits);
                }
            });
        }

        // Form Validation on Submit
        form.addEventListener('submit', function (e) {
            updateAge();
            // Validate Phone
            const digits = (phoneInput.value || '').replace(/\D/g, '');
            if (digits.length !== 10) {
                e.preventDefault();
                alert('Please enter a valid 10-digit phone number.');
                phoneInput.focus();
                return false;
            }
            phoneInput.value = formatPhoneDigits(digits);
            
            // Validate Age
            if (!birthInput.value) {
                e.preventDefault();
                alert('Please enter a valid birthdate.');
                birthInput.focus();
                return false;
            }
        });
        
        // Modal Logic (If included on Admin Add)
        const agreeLink = document.getElementById('termsLink');
        const modalOverlay = document.getElementById('termsModalOverlay');
        const modalCloses = modalOverlay ? modalOverlay.querySelectorAll('.modal-close') : [];
        if (agreeLink && modalOverlay) {
            agreeLink.addEventListener('click', function (ev) {
                ev.preventDefault();
                modalOverlay.style.display = 'flex';
            });
            modalOverlay.addEventListener('click', function (ev) {
                if (ev.target === modalOverlay) modalOverlay.style.display = 'none';
            });
            modalCloses.forEach(function(el){ 
                el.addEventListener('click', function(){ modalOverlay.style.display = 'none'; }); 
            });
        }
    });
})();
</script>

</body>
</html>